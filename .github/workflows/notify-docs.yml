# =============================================================================
# TEMPLATE: Copy this file to each sub-repo as .github/workflows/notify-docs.yml
#
# Required secret: DOCS_REPO_PAT (GitHub PAT with repo scope for F8ai/formul8-platform)
#   - Create a fine-grained PAT scoped to formul8-platform with Contents: Read
#     and Actions: Write permissions, or a classic PAT with repo scope.
#   - Add it as a repository secret named DOCS_REPO_PAT in each sub-repo.
#
# No per-repo customization needed. The dispatch table in docs-site controls
# which files map to which docs. This workflow just reports what changed.
# =============================================================================
name: Notify Docs of Changes

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    # Skip trivial commits that never need doc updates.
    # Only feat: and breaking changes are likely to need doc updates.
    if: >-
      !contains(github.event.head_commit.message, '[skip-docs]') &&
      !startsWith(github.event.head_commit.message, 'chore:') &&
      !startsWith(github.event.head_commit.message, 'chore(') &&
      !startsWith(github.event.head_commit.message, 'style:') &&
      !startsWith(github.event.head_commit.message, 'test:') &&
      !startsWith(github.event.head_commit.message, 'ci:') &&
      !startsWith(github.event.head_commit.message, 'revert:')
    steps:
      - name: Get changed files
        id: changes
        uses: actions/github-script@v7
        with:
          script: |
            const compare = await github.rest.repos.compareCommitsWithBasehead({
              owner: context.repo.owner,
              repo: context.repo.repo,
              basehead: `${context.payload.before}...${context.payload.after}`
            });
            const files = compare.data.files.map(f => f.filename);
            core.setOutput('files', JSON.stringify(files));
            console.log(`Changed files: ${files.join(', ')}`);

            // Build payload with proper JSON escaping to handle multi-line
            // commit messages (e.g., Co-authored-by trailers).
            const payload = JSON.stringify({
              source_repo: context.payload.repository.name,
              changed_files: files,
              commit_url: context.payload.head_commit?.url || '',
              commit_message: context.payload.head_commit?.message || '',
              author: context.payload.head_commit?.author?.username || 'unknown'
            });
            core.setOutput('payload', payload);

      - name: Dispatch to docs-site
        if: steps.changes.outputs.files != '[]'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.DOCS_REPO_PAT }}
          repository: F8ai/formul8-platform
          event-type: doc-impact
          client-payload: ${{ steps.changes.outputs.payload }}
